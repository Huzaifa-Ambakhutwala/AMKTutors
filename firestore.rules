rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Resolve the "Logical User ID" (Pointer or AuthUID)
    function getUserId() {
      let doc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && doc.data.pointer != null)
             ? doc.data.pointer 
             : request.auth.uid;
    }

    // Check if user matches the requested ID or the 'authUid' field
    function isOwner(userId) {
      return request.auth.uid == userId || getUserId() == userId ||
             (resource != null && resource.data.authUid == request.auth.uid);
    }

    // Fetch user role safely (resolves pointer if needed)
    function getRole() {
      let path = /databases/$(database)/documents/users/$(getUserId());
      return exists(path) ? get(path).data.role : 'None';
    }

    function isAdmin() {
      return isAuthenticated() && getRole() == 'ADMIN';
    }

    function isTutor() {
      return isAuthenticated() && getRole() == 'TUTOR';
    }

    function isParent() {
      return isAuthenticated() && getRole() == 'PARENT';
    }

    // --- Collection Rules ---

    // Verify if a claim (pointer) is valid
    function isValidClaim() {
      let pointer = request.resource.data.pointer;
      return pointer != null 
             && exists(/databases/$(database)/documents/users/$(pointer))
             && get(/databases/$(database)/documents/users/$(pointer)).data.authUid == request.auth.uid
             && get(/databases/$(database)/documents/users/$(pointer)).data.role == request.resource.data.role;
    }

    // 1. Users Collection
    match /users/{userId} {
      // Admins can read/write everything
      allow read, write: if isAdmin();
      
      // Users can read their own profile (ID match, AuthUid match, or Email match for invites)
      // Public can read if checking a valid invite link (inviteToken exists)
      allow read: if (resource.data.inviteToken != null) || 
                  (isAuthenticated() && (isOwner(userId) || resource.data.email == request.auth.token.email));
      
      // Users can create their own profile (SignUp flow)
      // Standard: No ADMIN role allowed
      // Exception: Valid Claim via Pointer (Invite Flow)
      allow create: if isOwner(userId) 
                    && (request.resource.data.role != 'ADMIN' || isValidClaim()); 
      
      // Users can update their own profile
      // OR claim an invited profile (Email match + Invited status)
      allow update: if isAuthenticated() && (
        (isOwner(userId) && request.resource.data.role == resource.data.role) ||
        (resource.data.email == request.auth.token.email && resource.data.status == 'invited')
      );
    }

    // 2. Students Collection
    match /students/{studentId} {
      // Admins have full access
      allow read, write: if isAdmin();

      // Tutors can read students they are assigned to
      allow read: if isTutor() && getUserId() in resource.data.tutorIds; // Updated

      // Parents can read students they are assigned to
      allow read: if isParent() && getUserId() in resource.data.parentIds; // Updated
    }

    // 3. Sessions Collection
    match /sessions/{sessionId} {
      // Admins have full access
      allow read, write: if isAdmin();

      // Tutors can read/update their own sessions
      allow read: if isTutor() && resource.data.tutorId == getUserId(); // Updated
      
      // Allow Tutors to update attendance/notes only
      allow update: if isTutor() 
                    && resource.data.tutorId == getUserId() // Updated
                    && request.resource.data.tutorId == resource.data.tutorId; // Cannot reassign session

      // Parents can read sessions for their children
      // We check if the session's student has the parent in 'parentIds'
      allow read: if isParent() 
                  && getUserId() in get(/databases/$(database)/documents/students/$(resource.data.studentId)).data.parentIds; // Updated
    }

    // 4. Invoices Collection
    match /invoices/{invoiceId} {
      // Admins have full access
      allow read, write: if isAdmin();

      // Parents can read their own invoices
      allow read: if isParent() && resource.data.parentId == getUserId(); // Updated
    }

    // 5. Assessments Collection (Legacy - keeping for migration)
    match /assessments/{assessmentId} {
      allow read, write: if isAdmin();
    }

    // 5.1 Evaluations (New)
    match /evaluations/{evaluationId} {
      allow read, write: if isAdmin();
    }

    // 6. PayStubs Collection
    match /payStubs/{stubId} {
      // Admins have full access
      allow read, write: if isAdmin();

      // Tutors can read their own pay stubs
      allow read: if isTutor() && resource.data.tutorId == getUserId(); // Updated
    }
    
    // 7. Settings Collection
    match /settings/{settingId} {
      allow read, write: if isAdmin();
    }

    // 8. Site Pages (CMS)
    match /sitePages/{slug} {
      // Public read allowed (contains publishedSections)
      allow read: if true;
      allow write: if isAdmin();
      
      match /versions/{versionId} {
        allow read, write: if isAdmin();
      }
    }

    // 9. Inquiries (Public Contact Form)
    match /inquiries/{inquiryId} {
      allow create: if true;
      allow read, update, delete: if isAdmin();
    }
    
    // Default Deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
